# üìö Base de Conhecimento - Configura√ß√µes GLPI Dashboard

## üéØ Vis√£o Geral
Este documento mapeia as configura√ß√µes **corretas e funcionais** do GLPI Dashboard ap√≥s as corre√ß√µes implementadas. Serve como refer√™ncia para manter a comunica√ß√£o API ‚Üí Backend ‚Üí Frontend ‚Üí Dashboard funcionando perfeitamente.

---

## üèóÔ∏è Arquitetura de Comunica√ß√£o

```mermaid
graph LR
    A[Frontend :5173] -->|Proxy /api| B[Vite Dev Server]
    B -->|http://localhost:5000| C[Backend :5000]
    C -->|API Calls| D[GLPI Server]
    
    E[Produ√ß√£o Frontend] -->|Direct| C
    
    style A fill:#e1f5fe
    style C fill:#f3e5f5
    style D fill:#fff3e0
```

---

## üé® FRONTEND - Configura√ß√µes Corretas

### üìÑ **httpClient.ts** - ‚≠ê CONFIGURA√á√ÉO CR√çTICA

```typescript
// frontend/services/httpClient.ts
import axios from 'axios';

// Fun√ß√£o que determina a URL base da API baseada no ambiente
function getApiBaseUrl(): string {
  // Em desenvolvimento, usa proxy relativo
  if (import.meta.env.DEV) {
    return '/api';  // ‚≠ê LINHA CR√çTICA - Usa proxy do Vite
  }
  
  // Em produ√ß√£o, usa URL absoluta das vari√°veis de ambiente
  return import.meta.env.VITE_API_BASE_URL || 'http://localhost:5000';
}

export const API_CONFIG = {
  BASE_URL: getApiBaseUrl(),
  TIMEOUT: parseInt(import.meta.env.VITE_API_TIMEOUT || '30000'),
  RETRY_ATTEMPTS: parseInt(import.meta.env.VITE_API_RETRY_ATTEMPTS || '3'),
  RETRY_DELAY: parseInt(import.meta.env.VITE_API_RETRY_DELAY || '1000'),
};

// Configura√ß√£o do cliente HTTP
const httpClient = axios.create({
  baseURL: API_CONFIG.BASE_URL,
  timeout: API_CONFIG.TIMEOUT,
  headers: {
    'Content-Type': 'application/json',
  },
});
```

**üéØ Por que funciona:**
- **Desenvolvimento**: `'/api'` ‚Üí Vite proxy redireciona para backend
- **Produ√ß√£o**: URL absoluta das vari√°veis de ambiente
- **Flex√≠vel**: Configur√°vel via vari√°veis de ambiente

---

### üìÑ **vite.config.ts** - Configura√ß√£o do Proxy

```typescript
// frontend/vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    host: '0.0.0.0',
    port: 5173,  // Porta do frontend
    proxy: {
      '/api': {
        target: 'http://localhost:5000',  // Backend
        changeOrigin: true,
        secure: false,
      },
    },
  },
});
```

**üéØ Fluxo do Proxy:**
1. Frontend faz requisi√ß√£o para `/api/health`
2. Vite intercepta e redireciona para `http://localhost:5000/api/health`
3. Backend responde
4. Vite retorna resposta para frontend

---

### üìÑ **frontend/.env.example** - Vari√°veis de Ambiente

```bash
# üåê Configura√ß√µes da API
VITE_API_BASE_URL=http://localhost:5000
VITE_API_TIMEOUT=30000
VITE_API_RETRY_ATTEMPTS=3
VITE_API_RETRY_DELAY=1000

# üìä Configura√ß√µes de Log e Debug
VITE_LOG_LEVEL=info
VITE_SHOW_PERFORMANCE=false
VITE_SHOW_API_CALLS=false
VITE_SHOW_CACHE_HITS=false

# üéØ Configura√ß√µes de Ambiente
VITE_APP_NAME=GLPI Dashboard
VITE_APP_VERSION=1.0.0
```

---

### üìÑ **frontend/src/config/environment.ts** - Configura√ß√µes Centralizadas

```typescript
export const ENV_CONFIG = {
  // üìä Configura√ß√µes de Log
  LOG_LEVEL: import.meta.env.VITE_LOG_LEVEL || 'info',
  SHOW_API_CALLS: import.meta.env.VITE_SHOW_API_CALLS === 'true',
  SHOW_PERFORMANCE: import.meta.env.VITE_SHOW_PERFORMANCE === 'true',
  
  // üéØ Ambiente
  IS_DEVELOPMENT: import.meta.env.DEV,
  IS_PRODUCTION: import.meta.env.PROD,
  MODE: import.meta.env.MODE,
  
  // üåê API
  API_BASE_URL: import.meta.env.VITE_API_BASE_URL || 'http://localhost:5000',
  API_TIMEOUT: parseInt(import.meta.env.VITE_API_TIMEOUT || '30000'),
};

export function getCurrentEnvironment(): 'development' | 'production' | 'test' {
  if (import.meta.env.DEV) return 'development';
  if (import.meta.env.PROD) return 'production';
  return 'test';
}
```

---

### üìÑ **frontend/src/config/appConfig.ts** - Configura√ß√£o Principal

```typescript
import { API_CONFIG } from '../services/httpClient';
import { ENV_CONFIG, getCurrentEnvironment } from './environment';

const endpointsConfig = {
  dashboard: '/dashboard',
  metrics: '/metrics',
  ranking: '/ranking',
  tickets: '/tickets',
  health: '/health',
};

const environmentConfigs = {
  development: {
    enableDebug: true,
    apiTimeout: 30000,
  },
  production: {
    enableDebug: false,
    apiTimeout: 90000,
  },
};

export const appConfig = {
  api: {
    ...API_CONFIG,
    endpoints: endpointsConfig,
  },
  environment: {
    ...ENV_CONFIG,
    ...environmentConfigs[getCurrentEnvironment()],
  },
};

export function getApiUrl(endpoint: keyof typeof endpointsConfig): string {
  const baseUrl = appConfig.api.BASE_URL;
  const endpointPath = endpointsConfig[endpoint];
  
  if (baseUrl === '/api') {
    return `${baseUrl}${endpointPath}`;
  }
  
  return `${baseUrl}/api${endpointPath}`;
}
```

---

## üîß BACKEND - Configura√ß√µes Corretas

### üìÑ **backend/config/settings.py** - Configura√ß√µes Principais

```python
# backend/config/settings.py
class Config:
    # üåê Configura√ß√µes de Rede
    HOST = os.getenv('HOST', '0.0.0.0')
    PORT = int(os.getenv('PORT', 5000))
    
    # üåç CORS - CR√çTICO para comunica√ß√£o frontend
    @property
    def CORS_ORIGINS(self) -> list:
        origins = os.getenv('CORS_ORIGINS', 
            'http://localhost:3000,http://localhost:5173,http://localhost:3001')
        return origins.split(',') if isinstance(origins, str) else origins
    
    # üîó URLs de API
    GLPI_URL = os.getenv('GLPI_URL', 'http://cau.ppiratini.intra.rs.gov.br/glpi/apirest.php')
    BACKEND_API_URL = os.getenv('BACKEND_API_URL', 'http://localhost:5000')
    
    # üîê Tokens GLPI
    GLPI_USER_TOKEN = os.getenv('GLPI_USER_TOKEN')
    GLPI_APP_TOKEN = os.getenv('GLPI_APP_TOKEN')
```

---

### üìÑ **Arquivos de Ambiente**

#### **.env** (Raiz do Projeto)
```bash
# üåê Configura√ß√µes de Rede
PORT=5000
HOST=0.0.0.0
GLPI_URL=http://cau.ppiratini.intra.rs.gov.br/glpi/apirest.php
BACKEND_API_URL=http://localhost:5000
CORS_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:3001

# üîê Tokens GLPI
GLPI_USER_TOKEN=TQdSxqg2e56PfF8ZJSX3iEJ1wCpHwhCkQJ2QtRnq
GLPI_APP_TOKEN=aY3f9F5aNHJmY8op0vTE4koguiPwpEYANp1JULid

# ‚ö° Performance
API_TIMEOUT=30
CACHE_DEFAULT_TIMEOUT=300

# üìä Observabilidade
LOG_LEVEL=INFO
ENABLE_METRICS=true
ENABLE_TRACING=false
```

#### **backend/.env** (Backend Espec√≠fico)
```bash
# üîß Configura√ß√µes Flask
FLASK_APP=app.py
FLASK_ENV=development
FLASK_DEBUG=1

# üåê Configura√ß√µes de Rede
PORT=5000
HOST=0.0.0.0
GLPI_URL=http://cau.ppiratini.intra.rs.gov.br/glpi/apirest.php
BACKEND_API_URL=http://localhost:5000
CORS_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:3001

# üîê Tokens GLPI
GLPI_USER_TOKEN=TQdSxqg2e56PfF8ZJSX3iEJ1wCpHwhCkQJ2QtRnq
GLPI_APP_TOKEN=aY3f9F5aNHJmY8op0vTE4koguiPwpEYANp1JULid

# üóÑÔ∏è Cache Redis
REDIS_URL=redis://localhost:6379/0
CACHE_TYPE=redis
CACHE_DEFAULT_TIMEOUT=300

# üìä Observabilidade
LOG_LEVEL=DEBUG
ENABLE_METRICS=true
ENABLE_TRACING=true
```

#### **docker.env** (Produ√ß√£o)
```bash
# üê≥ Configura√ß√µes Docker - Produ√ß√£o

# üåê Configura√ß√µes GLPI
GLPI_URL=http://cau.ppiratini.intra.rs.gov.br/glpi/apirest.php
GLPI_USER_TOKEN=TQdSxqg2e56PfF8ZJSX3iEJ1wCpHwhCkQJ2QtRnq
GLPI_APP_TOKEN=aY3f9F5aNHJmY8op0vTE4koguiPwpEYANp1JULid

# üîß Configura√ß√µes Flask
FLASK_APP=app.py
FLASK_ENV=production
FLASK_DEBUG=0

# üåê Configura√ß√µes de Rede
PORT=5000
HOST=0.0.0.0
BACKEND_API_URL=http://localhost:5000

# üîê Seguran√ßa
SECRET_KEY=glpi_dashboard_production_secret_key_2025_secure

# ‚ö° Performance
API_TIMEOUT=90
CACHE_DEFAULT_TIMEOUT=300

# üåç CORS
CORS_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:3001

# üìä Observabilidade
LOG_LEVEL=INFO
ENABLE_METRICS=true
ENABLE_TRACING=false
```

---

## üîÑ Fluxo de Dados Completo

### üöÄ **Desenvolvimento (npm run dev)**

```mermaid
sequenceDiagram
    participant F as Frontend :5173
    participant V as Vite Proxy
    participant B as Backend :5000
    participant G as GLPI Server
    
    F->>V: GET /api/health
    V->>B: GET http://localhost:5000/api/health
    B->>B: Process request
    B->>V: 200 OK + JSON
    V->>F: 200 OK + JSON
    
    Note over F,V: Proxy transparente
    Note over B,G: Comunica√ß√£o direta
```

**üéØ URLs em Desenvolvimento:**
- Frontend: `http://localhost:5173`
- API via Proxy: `http://localhost:5173/api/*`
- Backend Direto: `http://localhost:5000/api/*`

### üè≠ **Produ√ß√£o (Docker)**

```mermaid
sequenceDiagram
    participant F as Frontend
    participant B as Backend :5000
    participant G as GLPI Server
    
    F->>B: GET http://localhost:5000/api/health
    B->>B: Process request
    B->>F: 200 OK + JSON
    
    Note over F,B: Comunica√ß√£o direta
    Note over B,G: Comunica√ß√£o direta
```

**üéØ URLs em Produ√ß√£o:**
- Frontend: Servido pelo nginx
- API: `http://localhost:5000/api/*`

---

## üß™ Testes de Valida√ß√£o

### ‚úÖ **Checklist de Funcionamento**

**Desenvolvimento:**
- [x] Frontend carrega em `http://localhost:5173`
- [x] Requisi√ß√µes usam `/api` (URL relativa)
- [x] Proxy Vite redireciona para `http://localhost:5000`
- [x] Backend responde em `http://localhost:5000/api/health`
- [x] CORS permite origem `http://localhost:5173`
- [x] Dados do GLPI s√£o carregados corretamente

**Comandos de Teste Validados:**
```bash
# ‚úÖ Testar backend direto
curl http://localhost:5000/api/health
# Resultado: 200 OK + JSON

# ‚úÖ Testar proxy (com frontend rodando)
curl http://localhost:5173/api/health
# Resultado: 200 OK + JSON (via proxy)

# ‚úÖ Verificar CORS
Invoke-WebRequest -Uri "http://localhost:5000/api/health" -Headers @{"Origin"="http://localhost:5173"}
# Resultado: 200 OK + Headers CORS
```

---

## üö® Problemas Comuns e Solu√ß√µes

### ‚ùå **Problema: CORS Error**
**Sintoma:** `Access to fetch at 'http://localhost:5000/api/health' from origin 'http://localhost:5173' has been blocked by CORS policy`

**‚úÖ Solu√ß√£o:**
1. Verificar `CORS_ORIGINS` nos arquivos `.env`
2. Incluir `http://localhost:5173` na lista
3. Reiniciar backend

### ‚ùå **Problema: Proxy n√£o funciona**
**Sintoma:** Requisi√ß√µes para `/api/*` retornam 404

**‚úÖ Solu√ß√£o:**
1. Verificar se `httpClient.ts` usa `'/api'` em desenvolvimento
2. Confirmar configura√ß√£o do proxy no `vite.config.ts`
3. Reiniciar frontend

### ‚ùå **Problema: Backend n√£o responde**
**Sintoma:** `ERR_CONNECTION_REFUSED`

**‚úÖ Solu√ß√£o:**
1. Verificar se backend est√° rodando na porta 5000
2. Confirmar vari√°vel `PORT=5000` no `.env`
3. Verificar logs do backend para erros

---

## üéØ Configura√ß√µes por Ambiente

| Ambiente | Frontend URL | Backend URL | Proxy | CORS |
|----------|-------------|-------------|-------|------|
| **Desenvolvimento** | `http://localhost:5173` | `http://localhost:5000` | ‚úÖ Vite | ‚úÖ Configurado |
| **Produ√ß√£o** | Nginx | `http://localhost:5000` | ‚ùå Direto | ‚úÖ Configurado |
| **Docker** | Container | Container | ‚ùå Direto | ‚úÖ Configurado |

---

## üìã Resumo das Configura√ß√µes Cr√≠ticas

### üî• **Mais Importantes (Ordem de Prioridade)**

1. **httpClient.ts - L√≥gica Condicional** ‚≠ê‚≠ê‚≠ê
   ```typescript
   return import.meta.env.DEV ? '/api' : import.meta.env.VITE_API_BASE_URL;
   ```

2. **CORS_ORIGINS nos .env** ‚≠ê‚≠ê
   ```bash
   CORS_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:3001
   ```

3. **Vite Proxy Configuration** ‚≠ê‚≠ê
   ```typescript
   proxy: { '/api': { target: 'http://localhost:5000' } }
   ```

4. **Vari√°veis de Ambiente Frontend** ‚≠ê
   ```bash
   VITE_API_BASE_URL=http://localhost:5000
   ```

### üéØ **Resultado Final**
- ‚úÖ **Frontend**: `http://localhost:5173` (funcionando)
- ‚úÖ **Backend**: `http://localhost:5000` (funcionando)
- ‚úÖ **Proxy**: `/api/*` ‚Üí `http://localhost:5000/api/*` (funcionando)
- ‚úÖ **CORS**: Configurado para todas as origens necess√°rias
- ‚úÖ **GLPI**: Conectado e respondendo

---

## üöÄ Comandos de Inicializa√ß√£o

```bash
# üîß Backend
cd backend
python -m flask run --host=0.0.0.0 --port=5000

# üé® Frontend (novo terminal)
cd frontend
npm run dev

# üåê Acessar
# Frontend: http://localhost:5173
# Backend: http://localhost:5000/api/health
```

**üéâ Dashboard GLPI funcionando perfeitamente!**